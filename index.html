
<!DOCTYPE html>
<head>
	<meta charset="utf-8">
	<script src="http://d3js.org/d3.v3.min.js"></script>
	<script src="http://d3js.org/queue.v1.min.js"></script>
	<script src="http://d3js.org/topojson.v0.min.js"></script>
	<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/skeleton/2.0.4/skeleton.min.css">
	<link rel="stylesheet" type="text/css" href="style.css">
</head>

<body>
	<div class="row">
		<div class="six columns" id="title">
			<h1> So you want to be a <span class="emphasized">billionaire?</span></h1>
		</div>
		<div class ="six columns" id="paragraph">
			<p>In 2014, there were <span class="emphasized">1,645 billionaires</span> in the world.  Together, these individuals represent a net worth of more than $6.4 trillion.  The visualizations presented here illustrate how billionaires are distributed around the world, the industires that made them wealthy and other characteristics, such as age and education.</p>
			<p>The globe rotates to show where billionaires live around the world.  Data can be filtered by industry.  Click on the map to see the country selected and number of billionaires from the country in question.</p>
		</div>
	</div>
	<div id="spacer"></div>
	<div id='buttons'></div>
	<div class="row">
		<div class="six columns" id="globe"></div>
		<div class="six columns" id="right-side">
			<div id='menu'></div>
			<div id="outputs">
				<p class="emphasized">Country selected:</p>
				<div id="country_selected">---</div>
				<br>
				<p class="emphasized">Number of billionaires:</p>
				<div id="number_billionaires">---</div>
			</div>	
		</div>
	</div>	
	<div id="footer">
		<p>Data comes from Forbes, as accessed through <a href="https://import.io/data/set/?mode=loadSet&set=f6bf4b86-ce14-4969-ba0a-eb2bdcbcb2a4">import.io.</a></p>  
</body>

<script>
// Portions of code below modified from the following sources
// http://bl.ocks.org/3795040
// http://bl.ocks.org/dwtkns/4686432

d3.select(window)
    .on("mousemove", mousemove)
    .on("mouseup", mouseup);

var width = 360,
    height = 500,
    centered;

var proj = d3.geo.orthographic()
	// .scale(220)
    .scale(width/2.1)
    .translate([width / 2, height / 2])
    .clipAngle(90);

var path = d3.geo.path().projection(proj).pointRadius(1.5);

var graticule = d3.geo.graticule();

var svg = d3.select("#globe").append("svg")
    .attr("width", width)
    .attr("height", height)
    .on("mousedown", mousedown);

queue()
    .defer(d3.json, "data/world-110m.json")
    .defer(d3.csv, "data/data.csv")
    .defer(d3.csv, "data/countries.csv")
    .await(ready);


function ready(error, world, bilData, countryCodes) {

	// Styling the globe
	var ocean_fill = svg.append("defs").append("radialGradient")
	        .attr("id", "ocean_fill")
	        .attr("cx", "75%")
	        .attr("cy", "25%");
	    ocean_fill.append("stop").attr("offset", "5%").attr("stop-color", "#ddf");
	    ocean_fill.append("stop").attr("offset", "100%").attr("stop-color", "#9ab");

	var globe_highlight = svg.append("defs").append("radialGradient")
	        .attr("id", "globe_highlight")
	        .attr("cx", "75%")
	        .attr("cy", "25%");
	    globe_highlight.append("stop")
	        .attr("offset", "5%").attr("stop-color", "#ffd")
	        .attr("stop-opacity","0.6");
	    globe_highlight.append("stop")
	        .attr("offset", "100%").attr("stop-color", "#ba9")
	        .attr("stop-opacity","0.2");

	var globe_shading = svg.append("defs").append("radialGradient")
	        .attr("id", "globe_shading")
	        .attr("cx", "50%")
	        .attr("cy", "40%");
	    globe_shading.append("stop")
	        .attr("offset","50%").attr("stop-color", "#9ab")
	        .attr("stop-opacity","0")
	    globe_shading.append("stop")
	        .attr("offset","100%").attr("stop-color", "#3e6184")
	        .attr("stop-opacity","0.3")

	var drop_shadow = svg.append("defs").append("radialGradient")
	        .attr("id", "drop_shadow")
	        .attr("cx", "50%")
	        .attr("cy", "50%");
	    drop_shadow.append("stop")
	        .attr("offset","20%").attr("stop-color", "#000")
	        .attr("stop-opacity",".5")
	    drop_shadow.append("stop")
	        .attr("offset","100%").attr("stop-color", "#000")
	        .attr("stop-opacity","0")  

    svg.append("ellipse")
    	// .attr("cx", 440).attr("cy", 450)
        .attr("cx", width/2.5).attr("cy", height / 1.2)
        .attr("rx", proj.scale()*.90)
        .attr("ry", proj.scale()*.25)
        .attr("class", "noclicks")
        .style("fill", "url(#drop_shadow)");

    svg.append("circle")
        .attr("cx", width / 2).attr("cy", height / 2)
        .attr("r", proj.scale())
        .attr("class", "noclicks")
        .style("fill", "url(#ocean_fill)");

    svg.append("path")
        .datum(graticule)
        .attr("class", "graticule noclicks")
        .attr("d", path);

    svg.append("circle")
        .attr("cx", width / 2).attr("cy", height / 2)
        .attr("r", proj.scale())
        .attr("class","noclicks")
        .style("fill", "url(#globe_highlight)");

    svg.append("circle")
        .attr("cx", width / 2).attr("cy", height / 2)
        .attr("r", proj.scale())
        .attr("class","noclicks")
        .style("fill", "url(#globe_shading)");
    // End of world building

    // uncomment for hover-able country outlines
    svg.append("g").attr("class","countries")
      .selectAll("path")
        .data(topojson.object(world, world.objects.countries).geometries)
      .enter().append("path")
        .attr("d", path);

    // End of world set up -- also the end of cody modified from the above sources

    // Beginning of adding and plotting data as a choropleth
	plot_countries (world, bilData, countryCodes, "All"); 

    var industries = ["All", "Technology", "Telecom", "Retail", "Investments", "Diversified", "Gaming", "Fashion and Retail", "Finance", "Food and Beverage", "Manufacturing", "Media", "Real Estate", "Energy", "Metals & Mining", "Automotive", "Business", "Logistics", "Construction & Engineering", "Health care", "Service", "Medicine", "Sports", "Oil"];
    
    // uncomment the following code to use buttons instead of the dropdown
    // d3.select("#buttons").selectAll("input").data(industries).enter().append("input").attr("type","button").attr("class","button").attr("id", function (d) {return d;}).attr("value", function (d) {return d;} )

	// d3.selectAll(".button").on("click", function(){
	//     plot_countries(world, bilData, countryCodes, this.id);
	// });  

    // create a dropdown
    var select = d3.select("#menu")
                .append("select")
                .attr("id","dropdown")
                .on("change", function() { plot_countries(world, bilData, countryCodes, this.value); });
                // adds the options
                select.selectAll("option")
                .data(industries)
                .enter().append("option")
                .attr("value", function(d) { return d;})
                .text(function(d) { return d; });

} 


function plot_countries (world, bilData, countryCodes, industryFilter) {
	// creating the choropleth coloring
    // bilData comes from data.csv, has country codes as 'country'
    // can match this code to countries.csv 'code' and then to 'id', which matches the map
    d3.selectAll("path").remove();

    svg.append("path")
        .datum(graticule)
        .attr("class", "graticule noclicks")
        .attr("d", path);

	// creating a dictionary with the key being country 3-letter code and value is id number
    var codeDict = {};
    // creating dictionary with key 3-letter code and value country name
    var nameDict = {}; 
    countryCodes.forEach(function (country) {
    	codeDict[country.code] = Number(country.id);
    	nameDict[country.id] = country.name;
    })

    var dict = {};
    var countries = topojson.object(world, world.objects.countries).geometries;
    var countryPaths = svg.append('g');
    countryPaths.selectAll("path").data(countries).enter()
	.append("path")
	.attr("d", path);
    svg.append("g").attr("class","countries")
      	.selectAll("path")
        .data(topojson.object(world, world.objects.countries).geometries)
      	.enter().append("path")
        .attr("d", path)
        .on("click", function (d) {
        	var value = dict[d.id];
        	if (value == undefined) { value = 0;}
        	console.log(nameDict[d.id] + ", " + value);
        	document.getElementById("country_selected").innerHTML = nameDict[d.id];
        	document.getElementById("number_billionaires").innerHTML = value;
        	d3.select("#country_selected").attr("innerHTML", nameDict[d.id]);
        	d3.select("#number_billionaires").attr("innerHTML", value);
        	return d.id;
        });


	// creating dictionary where key is country id number and value is the number of billionaires
    if (industryFilter == "All") {
	    bilData.forEach(function (person) {
    		var key = codeDict[person.country];
    		dict[key] = 0;
	    })
	    bilData.forEach(function (person) {
    		var key = codeDict[person.country];
    		dict[key]++;
	    })
    }else{
    	bilData.forEach(function (person) {
	    	if (person.source == industryFilter) {
	    		var key = codeDict[person.country];
	    		dict[key] = 0;
	    	}
	    	
	    })
	    bilData.forEach(function (person) {
	    	if (person.source == industryFilter) {
	    		var key = codeDict[person.country];
	    		dict[key]++;
	    	}
	    })
    }
    var max = Math.log(d3.max(d3.values(dict)));


	var fillScale = d3.scale.linear().domain([0,max/3]).range([ "#fff", "#9ACD32"]);
    countryPaths.selectAll("path")
		.style("fill", function (country) {
			var countryName = country.id;
			var value = dict[countryName];
			if(!value) return fillScale(Math.log(0));
			return fillScale(Math.log(value));
		}).attr("opacity", 0.75).attr("class", "country")
}


function position_labels() {
 	var centerPos = proj.invert([width/2,height/2]);
  	var arc = d3.geo.greatArc(); 
}

// modified from http://bl.ocks.org/1392560
var m0, o0;
function mousedown() {
 	m0 = [d3.event.pageX, d3.event.pageY];
 	o0 = proj.rotate();
 	d3.event.preventDefault();
}

function mousemove() {
  	if (m0) {
    	var m1 = [d3.event.pageX, d3.event.pageY]
    	, o1 = [o0[0] + (m1[0] - m0[0]) / 6, o0[1] + (m0[1] - m1[1]) / 6];
    	o1[1] = o1[1] > 30  ? 30  :
            o1[1] < -30 ? -30 :
            o1[1];
    	proj.rotate(o1);
    	refresh();
  	}
}

function mouseup() {
  	if (m0) {
    	mousemove();
    	m0 = null;
  	}
}

function refresh() {
  	svg.selectAll(".land").attr("d", path);
  	svg.selectAll("path").attr("d", path);
  	svg.selectAll(".graticule").attr("d", path);
  	svg.selectAll(".point").attr("d", path);
  	position_labels();
}

</script>